name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            cd ~/Youtube-Transcriptor-App
            
            # Ensure HTTPS remote (works without SSH keys)
            git remote set-url origin https://github.com/menahilnadeem08/Youtube-Transcriptor-App.git
            
            git fetch origin
            git reset --hard origin/main
            
            # Install yt-dlp if not present
            if ! command -v yt-dlp &> /dev/null; then
              sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
              sudo chmod a+rx /usr/local/bin/yt-dlp
            fi
            
            # Backend setup
            cd backend
            npm install --production
            
            # Update .env with all required environment variables
            # Note: Backend has defaults for PORT (3000), FRONTEND_URL, and Stripe Price IDs if not set
            echo "PORT=3000" > .env
            if [ -n "${{ secrets.FRONTEND_URL }}" ]; then
              echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> .env
            else
              echo "FRONTEND_URL=http://13.58.58.36/" >> .env
            fi
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
            echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> .env
            echo "STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}" >> .env
            echo "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}" >> .env
            echo "STRIPE_PRICE_ID_BASIC=${{ secrets.STRIPE_PRICE_ID_BASIC }}" >> .env
            echo "STRIPE_PRICE_ID_PREMIUM=${{ secrets.STRIPE_PRICE_ID_PREMIUM }}" >> .env
            
            pm2 restart youtube-backend || pm2 start server.js --name youtube-backend
            pm2 save
            
            # Frontend setup
            cd ../frontend
            
            # Create .env.production with all frontend environment variables
            echo "VITE_API_URL=/api" > .env.production
            
            npm install
            npm run build
            
            # Fix permissions
            sudo chmod -R 644 ~/Youtube-Transcriptor-App/frontend/dist/*
            sudo chmod 755 ~/Youtube-Transcriptor-App/frontend/dist/assets
            
            # Reload nginx to serve new build
            sudo systemctl reload nginx

