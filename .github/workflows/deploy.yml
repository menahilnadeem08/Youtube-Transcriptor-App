name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        id: ssh-test
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 10s
          script: |
            echo "üîç Testing SSH connection to EC2..."
            echo "‚úÖ SSH Connection Successful!"
            echo ""
            echo "üìä System Information:"
            echo "   Hostname: $(hostname)"
            echo "   IP Address: $(hostname -I | awk '{print $1}')"
            echo "   Uptime: $(uptime -p)"
            echo "   Disk Space:"
            df -h / | tail -1
            echo "   Memory:"
            free -h | grep Mem
            echo ""
            echo "üîß Checking required tools:"
            echo -n "   Node.js: " && node --version || echo "‚ùå Not installed"
            echo -n "   npm: " && npm --version || echo "‚ùå Not installed"
            echo -n "   PM2: " && pm2 --version || echo "‚ùå Not installed"
            echo -n "   yt-dlp: " && yt-dlp --version || echo "‚ùå Not installed"
            echo -n "   Git: " && git --version || echo "‚ùå Not installed"
            echo ""
            echo "üìÅ Checking project directory:"
            if [ -d ~/Youtube-Transcriptor-App ]; then
              echo "   ‚úÖ Project directory exists"
              cd ~/Youtube-Transcriptor-App
              echo "   Current branch: $(git branch --show-current 2>/dev/null || echo 'N/A')"
              echo "   Last commit: $(git log -1 --oneline 2>/dev/null || echo 'N/A')"
            else
              echo "   ‚ö†Ô∏è  Project directory not found"
            fi
            echo ""
            echo "‚úÖ SSH connection test completed successfully!"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            echo "üöÄ Starting deployment..."
            echo "üì° Connected to: $(hostname) ($(hostname -I | awk '{print $1}'))"
            echo ""
            
            cd ~/Youtube-Transcriptor-App
            
            # Ensure HTTPS remote (works without SSH keys)
            git remote set-url origin https://github.com/menahilnadeem08/Youtube-Transcriptor-App.git
            
            git fetch origin
            git reset --hard origin/main
            
            # Install yt-dlp if not present
            if ! command -v yt-dlp &> /dev/null; then
              sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
              sudo chmod a+rx /usr/local/bin/yt-dlp
            fi
            
            # Backend setup
            cd backend
            npm install --production
            
            # Update .env with all required environment variables
            # Note: Backend has defaults for PORT (3000), FRONTEND_URL, and Stripe Price IDs if not set
            echo "PORT=3000" > .env
            if [ -n "${{ secrets.FRONTEND_URL }}" ]; then
              echo "FRONTEND_URL=${{ secrets.FRONTEND_URL }}" >> .env
            else
              echo "FRONTEND_URL=http://3.14.107.148/" >> .env
            fi
            echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
            echo "GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}" >> .env
            echo "STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}" >> .env
            echo "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}" >> .env
            echo "STRIPE_PRICE_ID_BASIC=${{ secrets.STRIPE_PRICE_ID_BASIC }}" >> .env
            echo "STRIPE_PRICE_ID_PREMIUM=${{ secrets.STRIPE_PRICE_ID_PREMIUM }}" >> .env
            
            pm2 restart youtube-backend || pm2 start server.js --name youtube-backend
            pm2 save
            
            # Frontend setup
            cd ../frontend
            
            # Create .env.production with all frontend environment variables
            echo "VITE_API_URL=/api" > .env.production
            
            npm install
            echo "Starting Vite build..."
            npm run build -- --logLevel info
            echo "Vite build completed successfully!"
            
            # Fix permissions
            sudo chmod -R 644 ~/Youtube-Transcriptor-App/frontend/dist/*
            sudo chmod 755 ~/Youtube-Transcriptor-App/frontend/dist/assets
            
            # Reload nginx to serve new build
            sudo systemctl reload nginx
            
            echo ""
            echo "‚úÖ Deployment completed successfully!"
            echo ""
            echo "üìä Final Status Check:"
            echo "   PM2 Status:"
            pm2 list
            echo ""
            echo "   Nginx Status:"
            sudo systemctl is-active nginx && echo "   ‚úÖ Nginx is running" || echo "   ‚ùå Nginx is not running"
            echo ""
            echo "   Frontend Build:"
            if [ -d ~/Youtube-Transcriptor-App/frontend/dist ]; then
              echo "   ‚úÖ Frontend dist folder exists"
              echo "   Files: $(ls -1 ~/Youtube-Transcriptor-App/frontend/dist | wc -l) files"
            else
              echo "   ‚ö†Ô∏è  Frontend dist folder not found"
            fi
            echo ""
            echo "üéâ All deployment steps completed!"

